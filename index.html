<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Movie Search</title>
  <meta property="og:site_name" content="Movie Search" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://via.placeholder.com/500x750?text=No+Image" id="ogImage" />
  <meta property="og:title" content="Movie Search" id="ogTitle" />
  <meta property="og:description" content="Search and watch movies and series!" id="ogDescription" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
  <style>
    body {
      transition: background-color 0.3s, color 0.3s;
    }
    .dark body {
      background-color: #0f0f0f;
      color: #f9fafb;
    }
    .light body {
      background-color: #f3f4f6;
      color: #1f2937;
    }
    .score-ring {
      transform: rotate(-90deg);
      transform-origin: center;
    }
    .score-circle {
      transition: stroke-dasharray 0.3s ease, stroke 0.3s ease;
    }
    #modal {
      backdrop-filter: blur(8px);
    }
    .modal-content {
      max-height: 80vh;
      overflow-y: auto;
      scrollbar-width: thin;
      padding-right: 8px;
    }
    .dark .modal-content::-webkit-scrollbar {
      width: 8px;
    }
    .dark .modal-content::-webkit-scrollbar-track {
      background: #1f2937;
    }
    .dark .modal-content::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 4px;
    }
    .light .modal-content::-webkit-scrollbar {
      width: 8px;
    }
    .light .modal-content::-webkit-scrollbar-track {
      background: #e5e7eb;
    }
    .light .modal-content::-webkit-scrollbar-thumb {
      background: #9ca3af;
      border-radius: 4px;
    }
    .score-container {
      position: relative;
      width: 56px;
      height: 56px;
    }
    .score-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 14px;
      font-weight: 600;
    }
    .skeleton {
      background-color: #4b5563;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    #episodeList {
      max-height: 300px;
      overflow-y: auto;
      scrollbar-width: thin;
    }
    .dark #episodeList::-webkit-scrollbar {
      width: 8px;
    }
    .dark #episodeList::-webkit-scrollbar-track {
      background: #1f2937;
    }
    .dark #episodeList::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 4px;
    }
    .light #episodeList::-webkit-scrollbar {
      width: 8px;
    }
    .light #episodeList::-webkit-scrollbar-track {
      background: #e5e7eb;
    }
    .light #episodeList::-webkit-scrollbar-thumb {
      background: #9ca3af;
      border-radius: 4px;
    }
    .embed-preview {
      border-left: 4px solid #5865F2;
      padding-left: 8px;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center px-4 py-6">
  <div class="w-full max-w-6xl">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-4xl font-extrabold text-center dark:text-white light:text-black">ðŸŽ¬ Movie & Series Search</h1>
      <div class="flex items-center gap-4">
        <button id="themeToggle" class="p-2 rounded-full bg-gray-700 dark:bg-gray-700 light:bg-gray-300 text-white dark:text-white light:text-gray-900 hover:bg-gray-600 dark:hover:bg-gray-600 light:hover:bg-gray-400 transition">
          <svg id="themeIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
        </button>
        <button id="historyBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Search History</button>
        <button id="favouritesBtn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition">Favourites</button>
        <button id="recentlyWatchedBtn" class="px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 transition">Recently Watched</button>
      </div>
    </div>
    <div class="flex justify-center mb-10">
      <input id="searchInput" type="text" placeholder="Search for movies or series..." class="w-full max-w-xl p-4 rounded-l-md bg-gray-900 dark:bg-gray-900 light:bg-white text-white dark:text-white light:text-gray-900 border-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400 dark:placeholder-gray-400 light:placeholder-gray-500" />
      <button id="searchBtn" class="px-6 bg-blue-600 text-white rounded-r-md hover:bg-blue-700 transition">Search</button>
    </div>
    <div id="results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
  </div>

  <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-60 light:bg-opacity-40 hidden flex items-center justify-center z-50">
    <div class="modal-content bg-gray-800 dark:bg-gray-800 light:bg-white rounded-xl p-6 w-full max-w-2xl shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h2 id="modalTitle" class="text-2xl font-bold text-white dark:text-white light:text-gray-900"></h2>
        <div class="flex items-center gap-2">
          <button id="favouriteBtn" class="p-2 rounded-full bg-gray-700 dark:bg-gray-700 light:bg-gray-200 hover:bg-gray-600 dark:hover:bg-gray-600 light:hover:bg-gray-300 transition">
            <svg id="favouriteIcon" class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
          </button>
          <button id="shareBtn" class="p-2 rounded-full bg-blue-600 hover:bg-blue-700 transition">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
          </button>
          <button id="streamBtn" class="p-2 rounded-full bg-green-600 hover:bg-green-700 transition">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.2A1 1 0 0010 9.768v4.464a1 1 0 001.555.832l3.197-2.2a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          </button>
          <button id="closeModal" class="p-2 rounded-full bg-gray-700 dark:bg-gray-700 light:bg-gray-200 hover:bg-gray-600 dark:hover:bg-gray-600 light:hover:bg-gray-300 transition">
            <svg class="w-6 h-6 text-white dark:text-white light:text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
      </div>
      <img id="modalPoster" class="w-full h-64 object-cover rounded-lg mb-4" alt="Poster" />
      <p id="modalDescription" class="text-gray-300 dark:text-gray-300 light:text-gray-700 mb-4"></p>
      <div class="flex items-center mb-4">
        <div class="score-container mr-4">
          <svg class="score-ring w-full h-full">
            <circle cx="28" cy="28" r="24" fill="none" stroke="#2d3748" stroke-width="6"/>
            <circle id="modalScoreCircle" class="score-circle" cx="28" cy="28" r="24" fill="none" stroke="#4b5563" stroke-width="6" stroke-dasharray="0, 150"/>
          </svg>
          <span id="modalScore" class="score-text text-white dark:text-white light:text-gray-900"></span>
        </div>
        <p id="modalRelease" class="text-gray-400 dark:text-gray-400 light:text-gray-600"></p>
      </div>
      <h3 class="text-lg font-semibold text-white dark:text-white light:text-gray-900 mb-2">Cast</h3>
      <div id="modalCast" class="grid grid-cols-2 gap-4 mb-4"></div>
      <div id="episodeSection" class="hidden">
        <h3 class="text-lg font-semibold text-white dark:text-white light:text-gray-900 mb-2">Episodes</h3>
        <div class="flex mb-4">
          <select id="seasonSelect" class="w-full p-2 rounded-md bg-gray-900 dark:bg-gray-900 light:bg-white text-white dark:text-white light:text-gray-900"></select>
        </div>
        <div id="episodeList" class="grid gap-4"></div>
      </div>
    </div>
  </div>

  <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-60 light:bg-opacity-40 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 dark:bg-gray-800 light:bg-white rounded-xl p-6 w-full max-w-lg shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-white dark:text-white light:text-gray-900">Share</h2>
        <button id="closeShareModal" class="p-2 rounded-full bg-gray-700 dark:bg-gray-700 light:bg-gray-200 hover:bg-gray-600 dark:hover:bg-gray-600 light:hover:bg-gray-300 transition">
          <svg class="w-6 h-6 text-white dark:text-white light:text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="embed-preview">
          <img id="sharePreviewImage" src="https://via.placeholder.com/92x138?text=No+Image" alt="Preview" class="w-24 h-36 object-cover rounded mb-2" />
          <p id="sharePreviewType" class="text-sm font-semibold text-gray-400 dark:text-gray-400 light:text-gray-600"></p>
          <p id="sharePreviewTitle" class="text-sm font-bold text-white dark:text-white light:text-gray-900"></p>
          <p id="sharePreviewDescription" class="text-xs text-gray-300 dark:text-gray-300 light:text-gray-700"></p>
        </div>
        <div class="flex flex-col gap-2">
          <button id="shareDiscord" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M20.317 4.37a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0 12.543 12.543 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.068.068 0 00-.029.027C.533 9.045-.319 13.579.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028 14.09 14.09 0 001.226-1.994.076.076 0 00-.041-.106 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.134 10.44 10.44 0 00.372-.292.064.064 0 01.074-.01c.392.162.798.326 1.207.491.123.05.252.1.382.148a18.26 18.26 0 005.93 0 13.8 13.8 0 001.589-.639.068.068 0 01.077.009c.125.095.252.19.382.292a.077.077 0 01-.008.134c-.606.286-1.249.574-1.872.892a.077.077 0 00-.041.105c.36.698.77 1.362 1.226 1.994a.076.076 0 00.084.028 19.831 19.831 0 006.002-3.03.078.078 0 00.032-.057c.5-5.177-.838-9.673-3.548-13.66a.066.066 0 00-.03-.027zM8.02 15.331c-1.182 0-2.157-1.085-2.157-2.419 0-1.333.955-2.418 2.157-2.418 1.21 0 2.176 1.096 2.157 2.418 0 1.333-.956 2.419-2.157 2.419zm7.974 0c-1.182 0-2.157-1.085-2.157-2.419 0-1.333.955-2.418 2.157-2.418 1.21 0 2.176 1.096 2.157 2.418 0 1.333-.946 2.419-2.157 2.419z"/></svg>
            Share on Discord
          </button>
          <button id="shareTwitter" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"/></svg>
            Share on Twitter
          </button>
          <button id="shareFacebook" class="px-4 py-2 bg-blue-700 text-white rounded-md hover:bg-blue-800 transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103v3.333h-2.786c-.698 0-1.239.317-1.239 1.348v2.775h3.957l-.531 3.667h-3.426v7.98H9.101z"/></svg>
            Share on Facebook
          </button>
          <button id="copyLink" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-2M8 5a2 2 0 002 2h4a2 2 0 002-2M8 5a2 2 0 012-2h4a2 2 0 012 2"/></svg>
            Copy Link
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-60 light:bg-opacity-40 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 dark:bg-gray-800 light:bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-white dark:text-white light:text-gray-900">Search History</h2>
        <button id="closeHistoryModal" class="p-2 rounded-full bg-gray-700 dark:bg-gray-700 light:bg-gray-200 hover:bg-gray-600 dark:hover:bg-gray-600 light:hover:bg-gray-300 transition">
          <svg class="w-6 h-6 text-white dark:text-white light:text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <ul id="historyList" class="text-gray-300 dark:text-gray-300 light:text-gray-700"></ul>
    </div>
  </div>

  <div id="favouritesModal" class="fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-60 light:bg-opacity-40 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 dark:bg-gray-800 light:bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-white dark:text-white light:text-gray-900">Favourites</h2>
        <button id="closeFavouritesModal" class="p-2 rounded-full bg-gray-700 dark:bg-gray-700 light:bg-gray-200 hover:bg-gray-600 dark:hover:bg-gray-600 light:hover:bg-gray-300 transition">
          <svg class="w-6 h-6 text-white dark:text-white light:text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <ul id="favouritesList" class="text-gray-300 dark:text-gray-300 light:text-gray-700"></ul>
    </div>
  </div>

  <div id="recentlyWatchedModal" class="fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-60 light:bg-opacity-40 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 dark:bg-gray-800 light:bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-white dark:text-white light:text-gray-900">Recently Watched</h2>
        <button id="closeRecentlyWatchedModal" class="p-2 rounded-full bg-gray-700 dark:bg-gray-700 light:bg-gray-200 hover:bg-gray-600 dark:hover:bg-gray-600 light:hover:bg-gray-300 transition">
          <svg class="w-6 h-6 text-white dark:text-white light:text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <ul id="recentlyWatchedList" class="text-gray-300 dark:text-gray-300 light:text-gray-700"></ul>
    </div>
  </div>

  <script>
    const apiKey = '9adc0bbf543673c5fb45ab24a36599e1';
    const streamBaseUrl = 'https://multiembed.mov/directstream.php';
    const baseShareUrl = 'https://fmfau.github.io/';
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const resultsDiv = document.getElementById('results');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalPoster = document.getElementById('modalPoster');
    const modalDescription = document.getElementById('modalDescription');
    const modalScore = document.getElementById('modalScore');
    const modalScoreCircle = document.getElementById('modalScoreCircle');
    const modalRelease = document.getElementById('modalRelease');
    const modalCast = document.getElementById('modalCast');
    const episodeSection = document.getElementById('episodeSection');
    const seasonSelect = document.getElementById('seasonSelect');
    const episodeList = document.getElementById('episodeList');
    const closeModal = document.getElementById('closeModal');
    const favouriteBtn = document.getElementById('favouriteBtn');
    const favouriteIcon = document.getElementById('favouriteIcon');
    const shareBtn = document.getElementById('shareBtn');
    const shareModal = document.getElementById('shareModal');
    const closeShareModal = document.getElementById('closeShareModal');
    const shareDiscord = document.getElementById('shareDiscord');
    const shareTwitter = document.getElementById('shareTwitter');
    const shareFacebook = document.getElementById('shareFacebook');
    const copyLink = document.getElementById('copyLink');
    const sharePreviewImage = document.getElementById('sharePreviewImage');
    const sharePreviewType = document.getElementById('sharePreviewType');
    const sharePreviewTitle = document.getElementById('sharePreviewTitle');
    const sharePreviewDescription = document.getElementById('sharePreviewDescription');
    const streamBtn = document.getElementById('streamBtn');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const historyBtn = document.getElementById('historyBtn');
    const historyModal = document.getElementById('historyModal');
    const closeHistoryModal = document.getElementById('closeHistoryModal');
    const historyList = document.getElementById('historyList');
    const favouritesBtn = document.getElementById('favouritesBtn');
    const favouritesModal = document.getElementById('favouritesModal');
    const closeFavouritesModal = document.getElementById('closeFavouritesModal');
    const favouritesList = document.getElementById('favouritesList');
    const recentlyWatchedBtn = document.getElementById('recentlyWatchedBtn');
    const recentlyWatchedModal = document.getElementById('recentlyWatchedModal');
    const closeRecentlyWatchedModal = document.getElementById('closeRecentlyWatchedModal');
    const recentlyWatchedList = document.getElementById('recentlyWatchedList');
    const ogImage = document.getElementById('ogImage');
    const ogTitle = document.getElementById('ogTitle');
    const ogDescription = document.getElementById('ogDescription');

    let currentItem = null;
    let selectedSeason = 1;
    let selectedEpisode = 1;
    let seasonsData = [];
    let episodeCache = {};

    // Theme handling
    const savedTheme = Cookies.get('theme') || 'dark';
    document.documentElement.classList.add(savedTheme);
    updateThemeIcon(savedTheme);

    themeToggle.addEventListener('click', () => {
      const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
      document.documentElement.classList.remove('dark', 'light');
      document.documentElement.classList.add(newTheme);
      Cookies.set('theme', newTheme, { expires: 365 });
      updateThemeIcon(newTheme);
    });

    function updateThemeIcon(theme) {
      themeIcon.innerHTML = theme === 'dark' ? 
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />' :
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
    }

    // Skeleton loader for trending
    function displaySkeletonLoader() {
      resultsDiv.innerHTML = '';
      for (let i = 0; i < 12; i++) {
        const card = document.createElement('div');
        card.className = 'relative bg-gray-900 dark:bg-gray-900 light:bg-white rounded-lg overflow-hidden shadow-lg';
        card.innerHTML = `
          <div class="relative">
            <div class="w-full h-[450px] skeleton rounded-t-lg"></div>
            <div class="absolute bottom-2 right-2 w-14 h-14">
              <div class="w-full h-full skeleton rounded-full"></div>
            </div>
          </div>
          <div class="p-4">
            <div class="h-6 w-3/4 skeleton rounded mb-2"></div>
            <div class="h-4 w-1/2 skeleton rounded"></div>
          </div>
        `;
        resultsDiv.appendChild(card);
      }
    }

    // Fetch trending movies/series
    async function fetchTrending() {
      displaySkeletonLoader();
      try {
        const allResults = [];
        for (let page = 1; page <= 3; page++) {
          const response = await fetch(`https://api.themoviedb.org/3/trending/all/week?api_key=${apiKey}&page=${page}`);
          const data = await response.json();
          allResults.push(...data.results);
        }
        displayResults(allResults.slice(0, 50));
      } catch (error) {
        resultsDiv.innerHTML = '<p class="text-center text-red-500 col-span-full">Error fetching trending content. Please try again.</p>';
      }
    }

    // Search handling
    searchBtn.addEventListener('click', () => searchMedia(searchInput.value));
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchMedia(searchInput.value);
    });

    async function searchMedia(query) {
      if (!query) return;
      resultsDiv.innerHTML = '<p class="text-center text-gray-400 dark:text-gray-400 light:text-gray-600 col-span-full">Loading...</p>';
      saveSearchHistory(query);
      try {
        const response = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${apiKey}&query=${encodeURIComponent(query)}`);
        const data = await response.json();
        displayResults(data.results);
      } catch (error) {
        resultsDiv.innerHTML = '<p class="text-center text-red-500 col-span-full">Error fetching data. Please try again.</p>';
      }
    }

    function displayResults(results) {
      resultsDiv.innerHTML = '';
      if (results.length === 0) {
        resultsDiv.innerHTML = '<p class="text-center text-gray-400 dark:text-gray-400 light:text-gray-600 col-span-full">No results found.</p>';
        return;
      }

      results.forEach(item => {
        if (item.media_type === 'movie' || item.media_type === 'tv') {
          const title = item.title || item.name;
          const releaseDate = item.release_date || item.first_air_date || 'N/A';
          const score = item.vote_average ? (item.vote_average).toFixed(1) : 'N/A';
          const scorePercent = score !== 'N/A' ? score * 10 : 0;
          const strokeColor = score !== 'N/A' ? getScoreColor(score) : '#4b5563';
          const poster = item.poster_path ? `https://image.tmdb.org/t/p/w300${item.poster_path}` : 'https://via.placeholder.com/300x450?text=No+Image';
          const badge = item.media_type === 'tv' ? 
            '<span class="absolute top-2 left-2 bg-blue-600 text-white text-xs font-semibold px-2 py-1 rounded">Series</span>' : 
            '<span class="absolute top-2 left-2 bg-green-600 text-white text-xs font-semibold px-2 py-1 rounded">Movie</span>';

          const card = document.createElement('div');
          card.className = 'relative bg-gray-900 dark:bg-gray-900 light:bg-white rounded-lg overflow-hidden shadow-lg group cursor-pointer transform hover:scale-105 transition-transform duration-200';
          card.innerHTML = `
            <div class="relative">
              ${badge}
              <img src="${poster}" alt="${title}" class="w-full h-[450px] object-cover group-hover:opacity-80 transition duration-200" />
              <div class="absolute bottom-2 right-2 w-14 h-14">
                <svg class="score-ring w-full h-full">
                  <circle cx="28" cy="28" r="24" fill="none" stroke="#2d3748" stroke-width="6"/>
                  <circle class="score-circle" cx="28" cy="28" r="24" fill="none" stroke="${strokeColor}" stroke-width="6" stroke-dasharray="${scorePercent * 1.5}, 150"/>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center text-sm font-semibold text-white dark:text-white light:text-gray-900">
                  ${score}
                </div>
              </div>
            </div>
            <div class="p-4">
              <h2 class="text-lg font-semibold truncate text-white dark:text-white light:text-gray-900" title="${title}">${title}</h2>
              <p class="text-sm text-gray-400 dark:text-gray-400 light:text-gray-600">Release: ${releaseDate}</p>
            </div>
          `;
          card.addEventListener('click', () => openModal(item));
          resultsDiv.appendChild(card);
        }
      });
    }

    async function openModal(item, season = 1, episode = 1) {
      currentItem = item;
      selectedSeason = season;
      selectedEpisode = episode;
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      modalTitle.textContent = item.title || item.name;
      modalPoster.src = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : 'https://via.placeholder.com/500x750?text=No+Image';
      modalDescription.textContent = item.overview || 'No description available.';
      modalRelease.textContent = `Release: ${item.release_date || item.first_air_date || 'N/A'}`;
      const score = item.vote_average ? (item.vote_average).toFixed(1) : 'N/A';
      modalScore.textContent = score;
      const scorePercent = score !== 'N/A' ? score * 10 : 0;
      const strokeColor = score !== 'N/A' ? getScoreColor(score) : '#4b5563';
      modalScoreCircle.setAttribute('stroke', strokeColor);
      modalScoreCircle.setAttribute('stroke-dasharray', `${scorePercent * 1.5}, 150`);

      // Update favourite button
      const favourites = JSON.parse(Cookies.get('favourites') || '[]');
      const isFavourited = favourites.some(fav => fav.id === item.id && fav.media_type === item.media_type);
      favouriteIcon.classList.toggle('fill-current', isFavourited);
      favouriteIcon.classList.toggle('text-yellow-400', isFavourited);

      // Save to recently watched
      saveRecentlyWatched(item);

      // Fetch cast
      modalCast.innerHTML = '<p class="text-gray-400 dark:text-gray-400 light:text-gray-600">Loading cast...</p>';
      try {
        const endpoint = item.media_type === 'movie' ? `movie/${item.id}` : `tv/${item.id}`;
        const response = await fetch(`https://api.themoviedb.org/3/${endpoint}/credits?api_key=${apiKey}`);
        const data = await response.json();
        displayCast(data.cast.slice(0, 8));
      } catch (error) {
        modalCast.innerHTML = '<p class="text-red-500">Error loading cast.</p>';
      }

      // Handle episode selection for series
      if (item.media_type === 'tv') {
        episodeSection.classList.remove('hidden');
        seasonSelect.innerHTML = '<option>Loading seasons...</option>';
        episodeList.innerHTML = '<p class="text-gray-400 dark:text-gray-400 light:text-gray-600">Loading episodes...</p>';
        try {
          const response = await fetch(`https://api.themoviedb.org/3/tv/${item.id}?api_key=${apiKey}`);
          const data = await response.json();
          seasonsData = data.seasons.filter(season => season.season_number > 0);
          displaySeasons(seasonsData);
          await fetchEpisodes(item.id, selectedSeason);
        } catch (error) {
          episodeSection.innerHTML = '<p class="text-red-500">Error loading seasons.</p>';
        }
      } else {
        episodeSection.classList.add('hidden');
      }
    }

    function displaySeasons(seasons) {
      seasonSelect.innerHTML = '';
      seasons.forEach(season => {
        const option = document.createElement('option');
        option.value = season.season_number;
        option.textContent = `Season ${season.season_number}`;
        seasonSelect.appendChild(option);
      });
      seasonSelect.value = selectedSeason;
      seasonSelect.addEventListener('change', () => {
        selectedSeason = parseInt(seasonSelect.value);
        fetchEpisodes(currentItem.id, selectedSeason);
      });
    }

    async function fetchEpisodes(seriesId, seasonNumber) {
      try {
        const cacheKey = `${seriesId}_${seasonNumber}`;
        if (!episodeCache[cacheKey]) {
          const response = await fetch(`https://api.themoviedb.org/3/tv/${seriesId}/season/${seasonNumber}?api_key=${apiKey}`);
          episodeCache[cacheKey] = await response.json();
        }
        displayEpisodes(episodeCache[cacheKey].episodes);
      } catch (error) {
        episodeList.innerHTML = '<p class="text-red-500">Error loading episodes.</p>';
      }
    }

    async function getEpisodeDetails(seriesId, seasonNumber, episodeNumber) {
      const cacheKey = `${seriesId}_${seasonNumber}`;
      if (!episodeCache[cacheKey]) {
        const response = await fetch(`https://api.themoviedb.org/3/tv/${seriesId}/season/${seasonNumber}?api_key=${apiKey}`);
        episodeCache[cacheKey] = await response.json();
      }
      const episode = episodeCache[cacheKey].episodes.find(ep => ep.episode_number === episodeNumber);
      return episode ? { name: episode.name || 'Untitled', overview: episode.overview || 'No description available.' } : { name: 'Untitled', overview: 'No description available.' };
    }

    function displayEpisodes(episodes) {
      episodeList.innerHTML = '';
      if (episodes.length === 0) {
        episodeList.innerHTML = '<p class="text-gray-400 dark:text-gray-400 light:text-gray-600">No episodes available.</p>';
        return;
      }
      episodes.forEach(episode => {
        const episodeCard = document.createElement('div');
        episodeCard.className = 'p-4 bg-gray-900 dark:bg-gray-900 light:bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-800 dark:hover:bg-gray-800 light:hover:bg-gray-200 transition';
        episodeCard.innerHTML = `
          <h4 class="text-sm font-semibold text-white dark:text-white light:text-gray-900">Episode ${episode.episode_number}: ${episode.name || 'Untitled'}</h4>
          <p class="text-xs text-gray-400 dark:text-gray-400 light:text-gray-600">Aired: ${episode.air_date || 'N/A'}</p>
          <p class="text-xs text-gray-300 dark:text-gray-300 light:text-gray-700 truncate">${episode.overview || 'No description available.'}</p>
        `;
        episodeCard.addEventListener('click', () => {
          selectedEpisode = episode.episode_number;
          episodeList.querySelectorAll('div').forEach(card => card.classList.remove('ring-2', 'ring-blue-500'));
          episodeCard.classList.add('ring-2', 'ring-blue-500');
        });
        episodeList.appendChild(episodeCard);
      });
    }

    function displayCast(cast) {
      modalCast.innerHTML = '';
      if (cast.length === 0) {
        modalCast.innerHTML = '<p class="text-gray-400 dark:text-gray-400 light:text-gray-600">No cast information available.</p>';
        return;
      }
      cast.forEach(actor => {
        const actorCard = document.createElement('div');
        const profile = actor.profile_path ? `https://image.tmdb.org/t/p/w185${actor.profile_path}` : 'https://via.placeholder.com/185x278?text=No+Image';
        actorCard.innerHTML = `
          <img src="${profile}" alt="${actor.name}" class="w-full h-32 object-cover rounded-md mb-2" />
          <p class="text-sm font-semibold text-white dark:text-white light:text-gray-900">${actor.name}</p>
          <p class="text-xs text-gray-400 dark:text-gray-400 light:text-gray-600">${actor.character || 'N/A'}</p>
        `;
        modalCast.appendChild(actorCard);
      });
    }

    closeModal.addEventListener('click', () => {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
      resetOgTags();
    });

    favouriteBtn.addEventListener('click', () => {
      const favourites = JSON.parse(Cookies.get('favourites') || '[]');
      const isFavourited = favourites.some(fav => fav.id === currentItem.id && fav.media_type === currentItem.media_type);
      if (isFavourited) {
        const newFavourites = favourites.filter(fav => !(fav.id === currentItem.id && fav.media_type === currentItem.media_type));
        Cookies.set('favourites', JSON.stringify(newFavourites), { expires: 365 });
        favouriteIcon.classList.remove('fill-current', 'text-yellow-400');
      } else {
        favourites.push({
          id: currentItem.id,
          media_type: currentItem.media_type,
          title: currentItem.title || currentItem.name,
          poster_path: currentItem.poster_path
        });
        Cookies.set('favourites', JSON.stringify(favourites), { expires: 365 });
        favouriteIcon.classList.add('fill-current', 'text-yellow-400');
      }
      updateFavouritesModal();
    });

    streamBtn.addEventListener('click', () => {
      if (!currentItem) return;
      const theme = Cookies.get('theme') || 'dark';
      let streamUrl = `${streamBaseUrl}?video_id=${currentItem.id}&tmdb=1&theme=${theme}`;
      if (currentItem.media_type === 'tv') {
        streamUrl += `&s=${selectedSeason}&e=${selectedEpisode}`;
      }
      window.open(streamUrl, '_blank');
    });

    async function updateShareModal() {
      shareModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      const theme = Cookies.get('theme') || 'dark';
      let streamUrl = `${streamBaseUrl}?video_id=${currentItem.id}&tmdb=1&theme=${theme}`;
      let shareUrl = `${baseShareUrl}?id=${currentItem.id}&type=${currentItem.media_type}`;
      let title = currentItem.title || currentItem.name;
      let type = currentItem.media_type === 'tv' ? 'Series' : 'Movie';
      let description = `Watch here at ${streamUrl}`;
      let image = currentItem.poster_path ? `https://image.tmdb.org/t/p/w500${currentItem.poster_path}` : 'https://via.placeholder.com/500x750?text=No+Image';

      if (currentItem.media_type === 'tv') {
        streamUrl += `&s=${selectedSeason}&e=${selectedEpisode}`;
        shareUrl += `&s=${selectedSeason}&e=${selectedEpisode}`;
        const episodeDetails = await getEpisodeDetails(currentItem.id, selectedSeason, selectedEpisode);
        title = `Series, S${selectedSeason}E${selectedEpisode}: ${episodeDetails.name}`;
        description = `Watch ${currentItem.name} S${selectedSeason}E${selectedEpisode} at ${streamUrl}`;
      }

      // Update OG tags for Discord embed
      ogImage.setAttribute('content', image);
      ogTitle.setAttribute('content', title);
      ogDescription.setAttribute('content', description);

      // Update preview
      sharePreviewImage.src = currentItem.poster_path ? `https://image.tmdb.org/t/p/w92${currentItem.poster_path}` : 'https://via.placeholder.com/92x138?text=No+Image';
      sharePreviewType.textContent = type;
      sharePreviewTitle.textContent = title;
      sharePreviewDescription.textContent = description;

      // Share handlers
      shareDiscord.onclick = () => {
        navigator.clipboard.writeText(shareUrl).then(() => {
          alert('Link copied! Paste it in Discord to share.');
          shareModal.classList.add('hidden');
          document.body.style.overflow = currentItem ? 'hidden' : '';
        });
      };

      shareTwitter.onclick = () => {
        const text = currentItem.media_type === 'tv' ? 
          `Watching ${currentItem.name} S${selectedSeason}E${selectedEpisode} on Movie Search!` : 
          `Check out ${currentItem.title || currentItem.name} on Movie Search!`;
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(shareUrl)}`, '_blank');
        shareModal.classList.add('hidden');
        document.body.style.overflow = currentItem ? 'hidden' : '';
      };

      shareFacebook.onclick = () => {
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`, '_blank');
        shareModal.classList.add('hidden');
        document.body.style.overflow = currentItem ? 'hidden' : '';
      };

      copyLink.onclick = () => {
        navigator.clipboard.writeText(shareUrl).then(() => {
          alert('Link copied to clipboard!');
          shareModal.classList.add('hidden');
          document.body.style.overflow = currentItem ? 'hidden' : '';
        });
      };
    }

    function resetOgTags() {
      ogImage.setAttribute('content', 'https://via.placeholder.com/500x750?text=No+Image');
      ogTitle.setAttribute('content', 'Movie Search');
      ogDescription.setAttribute('content', 'Search and watch movies and series!');
    }

    shareBtn.addEventListener('click', updateShareModal);

    closeShareModal.addEventListener('click', () => {
      shareModal.classList.add('hidden');
      document.body.style.overflow = currentItem ? 'hidden' : '';
    });

    function getScoreColor(score) {
      const hue = (score * 12);
      return `hsl(${hue}, 70%, 50%)`;
    }

    // Search history
    function saveSearchHistory(query) {
      const history = JSON.parse(Cookies.get('searchHistory') || '[]');
      if (!history.includes(query)) {
        history.unshift(query);
        if (history.length > 10) history.pop();
        Cookies.set('searchHistory', JSON.stringify(history), { expires: 365 });
      }
      updateHistoryModal();
    }

    historyBtn.addEventListener('click', () => {
      updateHistoryModal();
      historyModal.classList.remove('hidden');
    });

    closeHistoryModal.addEventListener('click', () => {
      historyModal.classList.add('hidden');
    });

    function updateHistoryModal() {
      const history = JSON.parse(Cookies.get('searchHistory') || '[]');
      historyList.innerHTML = '';
      if (history.length === 0) {
        historyList.innerHTML = '<p>No search history.</p>';
        return;
      }
      history.forEach(query => {
        const li = document.createElement('li');
        li.className = 'cursor-pointer hover:text-blue-500 transition';
        li.textContent = query;
        li.addEventListener('click', () => {
          searchInput.value = query;
          searchMedia(query);
          historyModal.classList.add('hidden');
        });
        historyList.appendChild(li);
      });
    }

    // Favourites
    favouritesBtn.addEventListener('click', () => {
      updateFavouritesModal();
      favouritesModal.classList.remove('hidden');
    });

    closeFavouritesModal.addEventListener('click', () => {
      favouritesModal.classList.add('hidden');
    });

    async function updateFavouritesModal() {
      const favourites = JSON.parse(Cookies.get('favourites') || '[]');
      favouritesList.innerHTML = '';
      if (favourites.length === 0) {
        favouritesList.innerHTML = '<p>No favourites.</p>';
        return;
      }
      for (const fav of favourites) {
        const li = document.createElement('li');
        li.className = 'flex items-center gap-4 mb-2';
        const img = fav.poster_path ? `https://image.tmdb.org/t/p/w92${fav.poster_path}` : 'https://via.placeholder.com/92x138?text=No+Image';
        li.innerHTML = `
          <img src="${img}" alt="${fav.title}" class="w-12 h-18 object-cover rounded" />
          <span class="cursor-pointer hover:text-blue-500 transition">${fav.title}</span>
        `;
        li.addEventListener('click', async () => {
          try {
            const endpoint = fav.media_type === 'movie' ? `movie/${fav.id}` : `tv/${fav.id}`;
            const response = await fetch(`https://api.themoviedb.org/3/${endpoint}?api_key=${apiKey}`);
            const data = await response.json();
            data.media_type = fav.media_type;
            openModal(data);
            favouritesModal.classList.add('hidden');
          } catch (error) {
            console.error('Error fetching favorite details:', error);
            favouritesList.innerHTML = '<p class="text-red-500">Error loading favorite.</p>';
          }
        });
        favouritesList.appendChild(li);
      }
    }

    // Recently Watched
    function saveRecentlyWatched(item) {
      const recentlyWatched = JSON.parse(Cookies.get('recentlyWatched') || '[]');
      const itemData = {
        id: item.id,
        media_type: item.media_type,
        title: item.title || item.name,
        poster_path: item.poster_path
      };
      const exists = recentlyWatched.some(watched => watched.id === item.id && watched.media_type === item.media_type);
      if (!exists) {
        recentlyWatched.unshift(itemData);
        if (recentlyWatched.length > 10) recentlyWatched.pop();
        Cookies.set('recentlyWatched', JSON.stringify(recentlyWatched), { expires: 365 });
      }
      updateRecentlyWatchedModal();
    }

    recentlyWatchedBtn.addEventListener('click', () => {
      updateRecentlyWatchedModal();
      recentlyWatchedModal.classList.remove('hidden');
    });

    closeRecentlyWatchedModal.addEventListener('click', () => {
      recentlyWatchedModal.classList.add('hidden');
    });

    async function updateRecentlyWatchedModal() {
      const recentlyWatched = JSON.parse(Cookies.get('recentlyWatched') || '[]');
      recentlyWatchedList.innerHTML = '';
      if (recentlyWatched.length === 0) {
        recentlyWatchedList.innerHTML = '<p>No recently watched items.</p>';
        return;
      }
      for (const watched of recentlyWatched) {
        const li = document.createElement('li');
        li.className = 'flex items-center gap-4 mb-2';
        const img = watched.poster_path ? `https://image.tmdb.org/t/p/w92${watched.poster_path}` : 'https://via.placeholder.com/92x138?text=No+Image';
        li.innerHTML = `
          <img src="${img}" alt="${watched.title}" class="w-12 h-18 object-cover rounded" />
          <span class="cursor-pointer hover:text-blue-500 transition">${watched.title}</span>
        `;
        li.addEventListener('click', async () => {
          try {
            const endpoint = watched.media_type === 'movie' ? `movie/${watched.id}` : `tv/${watched.id}`;
            const response = await fetch(`https://api.themoviedb.org/3/${endpoint}?api_key=${apiKey}`);
            const data = await response.json();
            data.media_type = watched.media_type;
            openModal(data);
            recentlyWatchedModal.classList.add('hidden');
          } catch (error) {
            console.error('Error fetching recently watched details:', error);
            recentlyWatchedList.innerHTML = '<p class="text-red-500">Error loading item.</p>';
          }
        });
        recentlyWatchedList.appendChild(li);
      }
    }

    // Handle deep linking from share URLs
    async function handleDeepLink() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      const type = params.get('type');
      const season = parseInt(params.get('s') || '1');
      const episode = parseInt(params.get('e') || '1');

      if (id && (type === 'movie' || type === 'tv')) {
        try {
          const endpoint = type === 'movie' ? `movie/${id}` : `tv/${id}`;
          const response = await fetch(`https://api.themoviedb.org/3/${endpoint}?api_key=${apiKey}`);
          const data = await response.json();
          data.media_type = type;
          openModal(data, season, episode);
        } catch (error) {
          console.error('Error loading deep link:', error);
        }
      }
    }

    // Load trending content and handle deep links on page load
    fetchTrending();
    handleDeepLink();
  </script>
</body>
</html>